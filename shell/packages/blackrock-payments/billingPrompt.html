<!--
Sandstorm - Personal Cloud Sandbox
Copyright (c) 2015 Sandstorm Development Group, Inc. and contributors
All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<template name="billingPrompt">
  {{!--
    Prompts the user to choose a plan, and a credit card with which to pay for it. Once the user
    has chosen something, their quota is updated.

    Data inputs:
    - reason:
        "voluntary": The user clicked a "sign up" button or is upgrading a plan. Optionally,
          `previousPlan` is also passed in.
        "outOfStorage": User ran out of storage.
        "outOfCompute": User ran out of compute units.
        "outOfGrains": Demo mode may limit the number of grains created.
        "customApp": User wants to install a custom app.
    - onComplete: Function to call on completion. The parameter is a boolean: true if the user
        successfully chose a new plan (in which case the action prompting billing should continue)
        or false if they dismissed the popup without choosing anything (in which case the action
        should be canceled).

    This will be included at the top level HTML like:

      {{#if billingPromptReason}}
        {{>billingPrompt reason=billingPromptReason onComplete=onBillingPromptDone
                         topbar=globalTopbar db=globalDb accountsUi=globalAccountsUi}}
      {{/if}}

    (In this example, `billingPromptReason` is probably some session variable.)
  --}}

  {{> sandstormTopbarItem name="billing-prompt" topbar=topbar
                          onlyPopup=true popupTemplate="_billingPromptPopup"
                          onDismiss=onDismiss}}
</template>

<template name="_billingPromptPopup">
  {{#if isDemoUser}}
    {{#if customApp}}
      <h2>Want more?</h2>

      <p>Demo users can only install <a href="https://apps.sandstorm.io/?host={{origin}}" target="_blank">apps from Sandstorm.io</a>.<br>
        If you'd like to upload custom apps, please sign in.</p>
    {{else}}
      <h2>Want more?</h2>

      <p>You've reached the limits for a demo account.<br>
        If you'd like to continue using Sandstorm and<br>
        make your data permanent, please sign in.</p>
    {{/if}}
    <div class="login">
      {{> loginButtonsDialog accountsUi}}
    </div>
  {{else}}
    {{#if involuntary}}
      {{#if customApp}}
        <h2>Want to upload your own apps?</h2>

        <p>Free-plan users can only install <a href="https://apps.sandstorm.io/?host={{origin}}" target="_blank">apps from Sandstorm.io</a>.<br>
          If you'd like to upload custom apps, please upgrade your plan.</p>
      {{else}}
        <h2>Looks like you've run out of
          {{#if outOfGrains}}grains.{{/if}}
          {{#if outOfStorage}}storage.{{/if}}
          {{#if outOfCompute}}compute.{{/if}}
        </h2>
        <p>Don't worry, you can upgrade your plan.</p>
      {{/if}}
    {{else}}
      <h2>Choose a new plan</h2>
    {{/if}}

    {{>_billingPromptBody}}
  {{/if}}
</template>

<template name="_billingPromptBody">
  <div class="subscriptions">
    {{#each plans}}
      <div class="subscription {{_id}} {{#if isCurrent}}selected{{/if}} {{#if isSelecting}}selecting{{/if}}">
        {{#if price}}
          <iframe class="mobile-iframe-hack {{#if isFullscreen}}fullscreen{{/if}}" src="{{paymentsUrl}}/checkout#{{checkoutData}}"></iframe>
        {{/if}}

        <p>{{#if isCurrent}}Current Plan{{else}}&nbsp;{{/if}}</p>
        <table>
          <tr><td>{{_id}}</td></tr>
          <tr><td>
            {{#if price}}
              <p>${{renderDollars price}}</p>
              <p>/ month</p>
            {{else}}
              <p>FREE</p>
              <p>&nbsp;</p>
            {{/if}}
          </td></tr>
          <tr><td>
            <p>{{renderCu compute}} CU</p>
            <p>Compute Units*</p>
          </td></tr>
          <tr><td>
            <p>{{renderStorage storage}}</p>
            <p>Storage</p>
          </td></tr>
          <tr><td>
            <p>{{renderQuantity grains}}</p>
            <p># of Grains</p>
          </td></tr>
          <tr><td>
            <button>
              {{#if isCurrent}}
                Keep Plan
              {{else}}
                {{#if isUpgrade}}
                  Upgrade
                {{else}}
                  Downgrade
                {{/if}}
              {{/if}}
            </button>
          </td></tr>
        </table>
      </div>
    {{/each}}
  </div>

  <div class="faq">
    <h3>F. A. Q.</h3>

    <div class="answer">
      <h4>*What is a compute unit?</h4>

      <p>A compute unit is 1GB of RAM used for one hour. Sandstorm apps only use RAM while
        you are actively using them, so 200 CU should be plenty for most users.
        <a href="https://blog.sandstorm.io/news/2015-01-14-compute-units.html" target="_blank">
        Learn more about compute units Â»</a></p>
    </div><div class="answer">
      <h4>Which plan should I choose?</h4>

      <p>If you aren't sure, start small &mdash; you can upgrade at any time.</p>
    </div>

    <a class="button" href="mailto:support@sandstorm.io" target="_blank">Contact Support</a>
  </div>
</template>

<template name="billingUsage">
  <div class="usage">
    <h3>Usage</h3>
    {{#with plan=myPlan used=myUsage}}
      <table>
        <tr>
          <td>Compute Units</td>
          <td>
            <div class="progress-bar">
              <div style="width: {{renderPercent used.compute plan.compute}}%"></div>
            </div>
            <div class="used">not tracked yet (beta)</div>
            <div class="total"><span class="amount">{{renderCu plan.compute}}</span> total</div>
          </td>
        </tr>
        <tr>
          <td>Storage</td>
          <td>
            <div class="progress-bar">
              <div style="width: {{renderPercent used.storage plan.storage}}%"></div>
            </div>
            <div class="used"><span class="amount">{{renderStoragePrecise used.storage}}</span> used</div>
            <div class="total"><span class="amount">{{renderStorage plan.storage}}</span> total</div>
          </td>
        </tr>
        <tr>
          <td>Grains</td>
          <td>
            <span class="grain-count"><span class="used">{{renderQuantity used.grains}}</span> out of <span class="total">{{renderQuantity plan.grains}}</span></span>
          </td>
        </tr>
      </table>
      <hr>
      <p>Based on current plan: <span class="plan-name">{{plan._id}}</span>
          <button class="change-plan">change plan</button></p>
    {{/with}}
  </div>

  {{#if showPrompt}}
    {{>billingPrompt reason="voluntary" topbar=topbar db=db onComplete=promptClosed}}
  {{/if}}
</template>
