<!--
Sandstorm - Personal Cloud Sandbox
Copyright (c) 2015 Sandstorm Development Group, Inc. and contributors
All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<template name="billingPrompt">
  {{!--
    Prompts the user to choose a plan, and a credit card with which to pay for it. Once the user
    has chosen something, their quota is updated.

    Data inputs:
    - reason:
        "voluntary": The user clicked a "sign up" button or is upgrading a plan. Optionally,
          `previousPlan` is also passed in.
        "outOfStorage": User ran out of storage.
        "outOfCompute": User ran out of compute units.
        "outOfGrains": Demo mode may limit the number of grains created.
        "customApp": User wants to install a custom app.
    - onComplete: Function to call on completion. The parameter is a boolean: true if the user
        successfully chose a new plan (in which case the action prompting billing should continue)
        or false if they dismissed the popup without choosing anything (in which case the action
        should be canceled).

    This will be included at the top level HTML like:

      {{#if billingPromptReason}}
        {{>billingPrompt reason=billingPromptReason onComplete=onBillingPromptDone
                         topbar=globalTopbar db=globalDb accountsUi=globalAccountsUi}}
      {{/if}}

    (In this example, `billingPromptReason` is probably some session variable.)
  --}}

  {{> sandstormTopbarItem name="billing-prompt" topbar=topbar
                          onlyPopup=true popupTemplate="_billingPromptPopup"
                          onDismiss=onDismiss}}
</template>

<template name="_billingPromptPopup">
  <h4>Upgrade Account</h4>

  {{#if isDemoUser}}
    {{#if customApp}}
      <p class="reason">
        Sorry, demo users can only install
        <a href="https://apps.sandstorm.io/?host={{origin}}">apps from Sandstorm.io</a>. If you'd
        like to install custom apps, please sign in and choose a paid plan.
      </p>
    {{else}}
      <p>Thanks for trying the Sandstorm Demo! You've reached the limits for a demo account. If
        you'd like to continue using Sandstorm and make your data permanent, please sign in.</p>
    {{/if}}
    <div class="login">
      {{> loginButtonsDialog accountsUi}}
    </div>
  {{else}}
    <p class="reason">
      {{#if outOfGrains}}
        Oops! Your current account level only allows you to create {{myPlan.grains}} total grains
        (app instances). If you want to create more, please choose an upgraded plan:
      {{/if}}
      {{#if outOfStorage}}
        Oops! You're all out of storage. Your current account level only includes
        {{renderStorage myPlan.storage}} of storage space. You'll either need to delete some
        things, or you can upgrade to a larger plan:
      {{/if}}
      {{#if outOfCompute}}
        Oops! You're all out of compute units. Your current account level gives you
        {{renderCu myPlan.compute}} compute units per month. They recharge continuously, so you
        can either wait a while and try again, or you can upgrade to a larger plan:
      {{/if}}
      {{#if customApp}}
        Sorry, free-plan users can only install
        <a href="https://apps.sandstorm.io/?host={{origin}}">apps from Sandstorm.io</a>. If you'd
        like to install custom apps, please choose a paid plan.
      {{/if}}
    </p>

    {{>_billingPromptBody}}
  {{/if}}
</template>

<template name="_billingPromptBody">
  <div class="subscriptions">
    {{#each plans}}
      <div class="subscription {{_id}} {{#if isCurrent}}selected{{/if}} {{#if isSelecting}}selecting{{/if}}">
        <h4>{{_id}}</h4>
        <p>{{#if isCurrent}}(current){{else}}&nbsp;{{/if}}</p>
        <table>
          <tr>
            <td>{{renderCu compute}} CU</td>
            <td>Compute Units</td>
          </tr>
          <tr>
            <td>{{renderStorage storage}}</td>
            <td>Storage</td>
          </tr>
          <tr>
            <td>{{renderQuantity grains}}</td>
            <td># of Grains</td>
          </tr>
        </table>
        <hr>
        {{#if price}}
          <span>${{renderCents price}} / Month (FREE during beta)</span>
          <iframe class="mobile-iframe-hack {{#if isFullscreen}}fullscreen{{/if}}" src="{{paymentsUrl}}/checkout#{{checkoutData}}"></iframe>
        {{else}}
          <span>FREE</span>
        {{/if}}
      </div>
    {{/each}}
  </div>
</template>

<template name="billingUsage">
  <div class="usage">
    <h3>Usage</h3>
    {{#with plan=myPlan used=myUsage}}
      <table>
        <tr>
          <td>Compute Units</td>
          <td>
            <div class="progress-bar">
              <div style="width: {{renderPercent used.compute plan.compute}}%"></div>
            </div>
            <div class="used">not tracked yet (beta)</div>
            <div class="total"><span class="amount">{{renderStorage plan.compute}}</span> total</div>
          </td>
        </tr>
        <tr>
          <td>Storage</td>
          <td>
            <div class="progress-bar">
              <div style="width: {{renderPercent used.storage plan.storage}}%"></div>
            </div>
            <div class="used"><span class="amount">{{renderStoragePrecise used.storage}}</span> used</div>
            <div class="total"><span class="amount">{{renderStorage plan.storage}}</span> total</div>
          </td>
        </tr>
        <tr>
          <td>Grains</td>
          <td>
            <span class="grain-count"><span class="used">{{renderQuantity used.grains}}</span> out of <span class="total">{{renderQuantity plan.grains}}</span></span>
          </td>
        </tr>
      </table>
      <hr>
      <p>Based on current plan: <span class="plan-name">{{plan._id}}</span>
          <button class="change-plan">change plan</button></p>
    {{/with}}
  </div>

  {{#if showPrompt}}
    {{>billingPrompt reason="voluntary" topbar=topbar db=db onComplete=promptClosed}}
  {{/if}}
</template>
